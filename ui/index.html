<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RDFCon</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css"
    />
    <style>
      body {
        font-family: Arial, sans-serif;
      }
      form {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      label {
        margin-top: 5px;
        font-weight: bold;
      }
      input,
      select,
      textarea {
        width: calc(100% - 16px);
        padding: 6px;
        margin-top: 2px;
      }
      button {
        margin-top: 10px;
        padding: 8px 12px;
        align-self: flex-start;
      }
      .column-spec {
        border: 1px solid #ccc;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 5px;
      }
      form {
        max-width: 600px;
        margin: 0 auto;
      }
      label {
        display: block;
        margin-top: 10px;
      }
      input,
      select,
      textarea {
        width: 100%;
        padding: 8px;
        margin-top: 5px;
      }
      button {
        margin-top: 20px;
        padding: 10px 15px;
      }
    </style>
  </head>
  <body>
    <section class="section">
      <div class="container">
        <h1 class="title">RDFCon spec creator</h1>
        <form id="schemaForm">
          <div class="field">
            <label class="label" for="prefixes"
              >Prefixes (Turtle format):</label
            >
            <div class="control">
              <textarea
                class="textarea"
                id="prefixes"
                name="prefixes"
                rows="5"
                placeholder="@prefix ex: <https://example.org/> ."
              ></textarea>
            </div>
            <p class="help">
              Enter prefixes in Turtle format, e.g.,
              <code>@prefix ex: &lt;https://example.org/&gt; .</code>
            </p>
          </div>

          <div class="field">
            <label class="label" for="infile">Input File:</label>
            <div class="control">
              <input
                class="input"
                type="text"
                id="infile"
                name="infile"
                required
                placeholder="data.csv"
              />
            </div>
            <p class="help">
              [required] The CSV file to process, interpreted as an absolute
              path or a path relative to this file.
            </p>
          </div>

          <div class="field">
            <label class="label" for="outdir">Output Directory:</label>
            <div class="control">
              <input
                class="input"
                type="text"
                id="outdir"
                name="outdir"
                placeholder="./output"
              />
            </div>
            <p class="help">
              An optional directory for the output, defaults to the same
              directory as the input file.
            </p>
          </div>

          <div class="field">
            <label class="label" for="graph">Graph:</label>
            <div class="control">
              <input
                class="input"
                type="text"
                id="graph"
                name="graph"
                placeholder="ex:graph"
              />
            </div>
            <p class="help">
              An optional named graph to use for the generated RDF. If given,
              the output format will be .trig otherwise .ttl.
            </p>
          </div>

          <div class="field">
            <label class="label" for="namespace">Namespace:</label>
            <div class="control">
              <input
                class="input"
                type="text"
                id="namespace"
                name="namespace"
                placeholder="https://example.org/pid/"
              />
            </div>
            <p class="help">
              A namespace to use when minting IRIs for the identifier. If not
              given, the identifier will be assumed to already be a valid IRI.
            </p>
          </div>

          <div class="field">
            <label class="label" for="identifier">Identifier:</label>
            <div class="control">
              <input
                class="input"
                type="text"
                id="identifier"
                name="identifier"
                required
                placeholder="id"
              />
            </div>
            <p class="help">
              [required] Name of column with the unique identifiers for each
              row.
            </p>
          </div>

          <div class="field">
            <label class="label" for="types">Types (comma-separated):</label>
            <div class="control">
              <input
                class="input"
                type="text"
                id="types"
                name="types"
                required
                placeholder="schema:CreativeWork, ex:Resource"
              />
            </div>
            <p class="help">
              [required] Classes to assign to each resource, can have as many as
              you want.
            </p>
          </div>

          <div class="field">
            <label class="label">Columns:</label>
            <p class="help">
              Add column specifications. Available properties and their default
              values are specified in the schema.
            </p>
            <div id="columnsContainer"></div>
            <button
              class="button is-link is-light"
              type="button"
              id="addColumn"
            >
              Add Column
            </button>
          </div>

          <div class="field">
            <label class="label" for="template">Template:</label>
            <details>
              <summary>Template Information</summary>
              <p>
                An optional template to be evaluated for each row of the data.
                The template must be in turtle format and valid RDF after
                variable substitutions.
              </p>
              <ul>
                <li>
                  The template can contain placeholders like
                  <code>{id}</code> or <code>{author}</code>, where each
                  placeholder is the name of a column in the source data.
                </li>
                <li>
                  If the placeholder is the <code>{identifier}</code> column, it
                  will be substituted with the computed IRI for that column
                  instead of just the string.
                </li>
                <li>
                  Other columns may be made as IRIs manually in the template.
                </li>
                <li>
                  Limitations:
                  <ul>
                    <li>
                      It is not possible to split multiple values out of a cell,
                      like you can with the column maps.
                    </li>
                    <li>
                      Column names with punctuation characters or whitespace
                      cannot be processed. For the most reliable experience, try
                      to ensure that column names do not contain punctuation
                      characters or whitespace. Underscores are accepted.
                    </li>
                    <li>
                      All single/double quote chars and newlines will be removed
                      from the column values to avoid breaking the RDF.
                    </li>
                  </ul>
                </li>
              </ul>
              <p>Notes:</p>
              <ul>
                <li>
                  The template can use the prefixes declared in the prefixes
                  section of this document.
                </li>
                <li>
                  The template will be evaluated once for each row of the
                  dataset.
                </li>
              </ul>
            </details>
            <div class="control">
              <textarea
                class="textarea"
                id="template"
                name="template"
                rows="5"
                placeholder='{id} schema:comment "converted from csv using rdfcon"^^xsd:string .'
              ></textarea>
            </div>
          </div>

          <div class="field">
            <div class="control">
              <button class="button is-primary" type="submit">
                Download YAML
              </button>
            </div>
          </div>
        </form>
      </div>
    </section>

    <script src="https://unpkg.com/n3/browser/n3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <script>
      let columnCount = 0;

      document
        .getElementById("addColumn")
        .addEventListener("click", function () {
          const container = document.getElementById("columnsContainer");
          const columnDiv = document.createElement("div");
          columnDiv.classList.add("column-spec");

          columnDiv.innerHTML = `
          <label>Column Name:</label>
          <input type="text" name="column[${columnCount}][name]" required placeholder="headline" />
          <p class="help">[required] Name of the column.</p>

          <label>Predicate:</label>
          <input type="text" name="column[${columnCount}][predicate]" required placeholder="schema:headline" />
          <p class="help">[required] Predicate to use in RDF.</p>

          <label>Datatype:</label>
          <input type="text" name="column[${columnCount}][datatype]" placeholder="xsd:string" />
          <p class="help">Datatype of the column data. Default is <code>xsd:string</code>.</p>

          <label>Separator:</label>
          <input type="text" name="column[${columnCount}][separator]" placeholder="||" />
          <p class="help">A separator used to delineate multiple values per cell. Default is <code>null</code>.</p>

          <label>As IRI:</label>
          <input type="checkbox" name="column[${columnCount}][as_iri]" />
          <p class="help">If the value should be treated as an IRI, set this to <code>true</code>. Default is <code>false</code>.</p>

          <label>Namespace:</label>
          <input type="text" name="column[${columnCount}][namespace]" placeholder="https://example.org/agent/" />
          <p class="help">A namespace to use for the IRI. Only used if <code>as_iri</code> is <code>true</code> and the values for this column are not already IRIs.</p>

          <label>As UUID:</label>
          <input type="checkbox" name="column[${columnCount}][as_uuid]" />
          <p class="help">If <code>true</code>, create a UUID for the IRI instead of just using the values from the column. Only used if <code>as_iri</code> is <code>true</code>. Default is <code>false</code>.</p>

          <label>Ignore Case:</label>
          <input type="checkbox" name="column[${columnCount}][ignore_case]" />
          <p class="help">If <code>true</code>, apply a lowercase transformation on the column values before minting the UUID. Only used if <code>as_iri</code> is <code>true</code>. Default is <code>false</code>.</p>

          <label>Label:</label>
          <input type="text" name="column[${columnCount}][label]" placeholder="schema:name" />
          <p class="help">If given, declare a label for the minted IRI using this predicate.</p>

          <label>Type:</label>
          <input type="text" name="column[${columnCount}][type]" placeholder="schema:Text" />
          <p class="help">If given, declare the minted IRI as an instance of this class.</p>

          <button type="button" class="removeColumn">Remove</button>
        `;
          columnCount++;

          container.appendChild(columnDiv);

          columnDiv
            .querySelector(".removeColumn")
            .addEventListener("click", function () {
              container.removeChild(columnDiv);
            });
        });

      document
        .getElementById("schemaForm")
        .addEventListener("submit", function (event) {
          event.preventDefault();
          const formData = new FormData(event.target);
          const data = {
            columns: [],
          };

          formData.forEach((value, key) => {
            if (key === "types") {
              data[key] = value.split(",").map((item) => item.trim());
            } else if (key.startsWith("column")) {
              const columnIndexMatch = key.match(/column\[(\d+)\]/);
              if (columnIndexMatch) {
                const columnIndex = parseInt(columnIndexMatch[1], 10);
                const columnKey = key.split("]")[1].substring(1);
                if (!data.columns[columnIndex]) {
                  data.columns[columnIndex] = {};
                }
                data.columns[columnIndex][columnKey] = value || null;
              }
            } else {
              data[key] = value || null;
            }
          });
          const turtlePrefixes = document.getElementById("prefixes").value;
          const parser = new N3.Parser();
          const prefixes = {};

          parser.parse(turtlePrefixes, (error, quad, prefixesMap) => {
            if (error) {
              console.error(error);
              return;
            }
            if (prefixesMap) {
              Object.entries(prefixesMap).forEach(([prefix, uri]) => {
                prefixes[prefix] = `<${uri}>`;
              });
            }
            data.prefixes = Object.entries(prefixes).map(([prefix, uri]) => ({
              [prefix]: uri,
            }));

            // Remove null properties
            const cleanData = JSON.parse(
              JSON.stringify(data, (key, value) => {
                return value === null ? undefined : value;
              }),
            );

            const yamlData = jsyaml.dump(cleanData);
            const blob = new Blob([yamlData], { type: "text/yaml" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "spec.yaml";
            a.click();
            URL.revokeObjectURL(url);
          });
        });
    </script>
  </body>
</html>
