<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>YAML Schema Form</title>
    <style>
      body {
        font-family: Arial, sans-serif;
      }
      form {
        max-width: 600px;
        margin: 0 auto;
      }
      label {
        display: block;
        margin-top: 10px;
      }
      input,
      select,
      textarea {
        width: 100%;
        padding: 8px;
        margin-top: 5px;
      }
      button {
        margin-top: 20px;
        padding: 10px 15px;
      }
    </style>
  </head>
  <body>
    <h1>YAML Schema Form</h1>
    <form id="schemaForm">
      <label for="prefixes">Prefixes (Turtle format):</label>
      <small
        >Enter prefixes in Turtle format, e.g.,
        <code>@prefix ex: &lt;https://example.org/&gt; .</code></small
      >
      <textarea id="prefixes" name="prefixes" rows="5"></textarea>

      <label for="infile">Input File:</label>
      <small
        >[required] The CSV file to process, interpreted as an absolute path or
        a path relative to this file.</small
      >
      <input type="text" id="infile" name="infile" required />

      <label for="outdir">Output Directory:</label>
      <small
        >An optional directory for the output, defaults to the same directory as
        the input file.</small
      >
      <input type="text" id="outdir" name="outdir" />

      <label for="graph">Graph:</label>
      <small
        >An optional named graph to use for the generated RDF. If given, the
        output format will be .trig otherwise .ttl.</small
      >
      <input type="text" id="graph" name="graph" />

      <label for="namespace">Namespace:</label>
      <small
        >A namespace to use when minting IRIs for the identifier. If not given,
        the identifier will be assumed to already be a valid IRI.</small
      >
      <input type="text" id="namespace" name="namespace" />

      <label for="identifier">Identifier:</label>
      <small
        >[required] Name of column with the unique identifiers for each
        row.</small
      >
      <input type="text" id="identifier" name="identifier" required />

      <label for="types">Types (comma-separated):</label>
      <small
        >[required] Classes to assign to each resource, can have as many as you
        want.</small
      >
      <input type="text" id="types" name="types" required />

      <label>Columns:</label>
      <small
        >Add column specifications. Available properties and their default values are specified in the schema.</small
      >
      <div id="columnsContainer"></div>
      <button type="button" id="addColumn">Add Column</button>

      <label for="template">Template:</label>
      <small
        >An optional template to be evaluated for each row of the data. The
        template must be in turtle format and valid RDF after variable
        substitutions.</small
      >
      <textarea id="template" name="template" rows="5"></textarea>

      <button type="submit">Download YAML</button>
    </form>

    <script src="https://unpkg.com/n3/browser/n3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <script>
      document.getElementById("addColumn").addEventListener("click", function () {
        const container = document.getElementById("columnsContainer");
        const columnDiv = document.createElement("div");
        columnDiv.classList.add("column-spec");

        columnDiv.innerHTML = `
          <label>Column Name:</label>
          <input type="text" name="column" required />

          <label>Predicate:</label>
          <input type="text" name="predicate" required />

          <label>Datatype:</label>
          <input type="text" name="datatype" value="xsd:string" />

          <label>Separator:</label>
          <input type="text" name="separator" />

          <label>As IRI:</label>
          <input type="checkbox" name="as_iri" />

          <label>Namespace:</label>
          <input type="text" name="namespace" />

          <label>As UUID:</label>
          <input type="checkbox" name="as_uuid" />

          <label>Ignore Case:</label>
          <input type="checkbox" name="ignore_case" />

          <label>Label:</label>
          <input type="text" name="label" />

          <label>Type:</label>
          <input type="text" name="type" />

          <button type="button" class="removeColumn">Remove</button>
        `;

        container.appendChild(columnDiv);

        columnDiv.querySelector(".removeColumn").addEventListener("click", function () {
          container.removeChild(columnDiv);
        });
      });

      document.getElementById("schemaForm").addEventListener("submit", function (event) {
          event.preventDefault();
          const formData = new FormData(event.target);
          const data = {
            columns: [],
          };

          formData.forEach((value, key) => {
            if (key === "types") {
              data[key] = value.split(",").map((item) => item.trim());
            } else if (key.startsWith("column")) {
              const columnIndexMatch = key.match(/column\[(\d+)\]/);
              if (columnIndexMatch) {
                const columnIndex = parseInt(columnIndexMatch[1], 10);
                const columnKey = key.split("]")[1].substring(1);
                if (!data.columns[columnIndex]) {
                  data.columns[columnIndex] = {};
                }
                data.columns[columnIndex][columnKey] = value;
              }
            } else {
              data[key] = value || null;
            }
          });
          const turtlePrefixes = document.getElementById("prefixes").value;
          const parser = new N3.Parser();
          const prefixes = {};

          parser.parse(turtlePrefixes, (error, quad, prefixesMap) => {
            if (error) {
              console.error(error);
              return;
            }
            if (prefixesMap) {
              Object.entries(prefixesMap).forEach(([prefix, uri]) => {
                prefixes[prefix] = `<${uri}>`;
              });
            }
            data.prefixes = Object.entries(prefixes).map(([prefix, uri]) => ({
              [prefix]: uri,
            }));

            const yamlData = jsyaml.dump(data);
            const blob = new Blob([yamlData], { type: "text/yaml" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "spec.yaml";
            a.click();
            URL.revokeObjectURL(url);
          });
        });
    </script>
  </body>
</html>
