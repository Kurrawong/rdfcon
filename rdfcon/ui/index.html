<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RDFCon</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f4f4f9;
      }
      .container {
        max-width: 800px;
        margin: 20px auto;
        padding: 20px;
        background-color: #fff;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
      }
      h1 {
        font-size: 24px;
        margin-bottom: 20px;
        text-align: center;
      }
      form {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }
      label {
        font-weight: bold;
        margin-bottom: 5px;
      }
      input,
      select,
      textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
        margin-top: 4px;
      }
      .column-spec {
        border: 1px solid #ddd;
        padding: 10px;
        border-radius: 4px;
        background-color: #f9f9f9;
        margin-bottom: 4px;
      }
      summary {
        margin-bottom: 4px;
      }
      summary:hover {
        cursor: pointer;
      }
      #clearInfile {
        cursor: pointer;
        font-size: small;
        text-decoration: underline;
      }
      .required {
        font-weight: bold;
        color: darkred;
      }
      .hint {
        font-size: small;
        color: gray;
      }
      input[type="checkbox"] {
        width: auto;
      }
    </style>
  </head>
  <body>
    <section class="section">
      <div class="container">
        <h1 class="title">RDFCon spec creator</h1>
        <div class="container">
          <details open>
            <summary><strong>Usage</strong></summary>
            <p>
              This form will help you create a conversion spec for use with the
              <em>rdfcon</em> program.
            </p>
            <p>
              Fill out the <span class="required">[required]</span> information
              and then press
              <strong>Download YAML</strong>
              to generate the document.
            </p>
            <p>
              Once you have the YAML file downloaded you can provide it to the
              rdfcon program on the command line like so:
            </p>
            <p><code>$ rdfcon myfile-rdfcon.yaml</code></p>
          </details>
        </div>
        <form id="schemaForm" autocomplete="off">
          <div class="field">
            <label class="label" for="prefixes"
              >Prefixes (Turtle format):</label
            >
            <div class="control">
              <textarea
                class="textarea"
                id="prefixes"
                name="prefixes"
                rows="5"
                placeholder="@prefix ex: <https://example.org/> ."
              >
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .</textarea
              >
            </div>
            <p class="help">
              Enter prefixes in Turtle format, e.g.,
              <code>@prefix ex: &lt;https://example.org/&gt; .</code>
              Prefixes declared here, can then be referenced in the other fields
              of the document. like <code>xsd:string</code>
            </p>
          </div>

          <div class="field">
            <label class="label" for="infile">Input File:</label>
            <span id="clearInfile">clear</span>
            <div class="control">
              <input
                class="input"
                type="file"
                accept=".csv"
                id="infile"
                name="infile"
                required
                placeholder="data.csv"
              />
            </div>
            <p class="help">
              <span class="required">[required]</span> The CSV file to process.
            </p>
            <p class="hint">
              Due to browser security restrictions only the file name can be
              acquired. Because of this, you may need to manually update the
              'infile' property with the full path after downloading. The infile
              path can be an absolute path or a path relative to the spec file.
            </p>
          </div>

          <div class="field">
            <label class="label" for="outdir">Output Directory:</label>
            <div class="control">
              <input
                class="input"
                type="text"
                id="outdir"
                name="outdir"
                placeholder="./output"
              />
            </div>
            <p class="help">
              An optional directory for the output, defaults to the same
              directory as the input file.
            </p>
          </div>

          <div class="field">
            <label class="label" for="graph">Graph:</label>
            <div class="control">
              <input
                class="input"
                type="text"
                id="graph"
                name="graph"
                placeholder="ex:graph"
              />
            </div>
            <p class="help">
              An optional named graph to use for the generated RDF. If given,
              rdfcon will generate <code>.trig</code> otherwise
              <code>.ttl</code>.
            </p>
            <p class="hint">
              IRIs can be given with or without surrounding angle brackets, i.e.
              <code>&lt;https://example.org/predicate&gt;</code>
            </p>
          </div>

          <div class="field">
            <label class="label" for="namespace">Namespace:</label>
            <div class="control">
              <input
                class="input"
                type="text"
                id="namespace"
                name="namespace"
                placeholder="https://example.org/pid/"
              />
            </div>
            <p class="help">
              A namespace to use when minting IRIs for the identifier. If not
              given, the identifier will be assumed to already be a valid IRI.
            </p>
            <p class="hint">
              IRIs can be given with or without surrounding angle brackets, i.e.
              <code>&lt;https://example.org/predicate&gt;</code>
            </p>
          </div>

          <div class="field">
            <label class="label" for="identifier">Identifier:</label>
            <div class="control">
              <input
                class="input"
                type="text"
                id="identifier"
                name="identifier"
                required
                placeholder="id"
                list="csvHeaders"
              />
            </div>
            <p class="help">
              <span class="required">[required]</span> Name of the column with
              unique identifiers for each row.
            </p>
            <p>
              <span class="hint"
                >press down-arrow for autocomplete suggestions</span
              >
            </p>
          </div>

          <div class="field">
            <label class="label" for="types">Types (comma-separated):</label>
            <div class="control">
              <input
                class="input"
                type="text"
                id="types"
                name="types"
                placeholder="schema:CreativeWork, ex:Resource"
              />
            </div>
            <p class="help">
              Classes to assign to each resource, can have as many as you want.
            </p>
          </div>

          <div class="field">
            <datalist id="csvHeaders"></datalist>
            <label class="label">Columns:</label>
            <p class="help">Add column specifications.</p>
            <div id="columnsContainer"></div>
            <button
              class="button is-link is-light"
              type="button"
              id="addColumn"
            >
              Add Column
            </button>
          </div>

          <div class="field">
            <label class="label" for="template">Template:</label>
            <details class="container">
              <summary>Template Information</summary>
              <p>
                An optional template to be evaluated for each row of the data.
              </p>
              <p>The template <strong>must</strong></p>
              <ul>
                <li>be in turtle format</li>
                <li>be valid RDF after the variable substitutions.</li>
              </ul>
              <p>The template <strong>may</strong></p>
              <ul>
                <li>
                  contain placeholders like <code>{id}</code> or
                  <code>{author}</code>, where each placeholder is the name of a
                  column in the source data.
                </li>
                <li>use prefixes declared in the prefixes section</li>
              </ul>
              <p>Notes</p>
              <ul>
                <li>
                  If the placeholder is the <code>{identifier}</code> column, it
                  will be substituted with the namespaced IRI for that column
                  instead of just the string.
                </li>
                <li>
                  Other columns may be made as IRIs manually in the template. by
                  doing something like
                  <p>
                    <code
                      >{iri} schema:author
                      &lt;https://example.org/agent/{author}&gt; .</code
                    >
                  </p>
                </li>
              </ul>
            </details>
            <div class="control">
              <textarea
                class="textarea"
                id="template"
                name="template"
                rows="5"
                placeholder='{id} schema:comment "converted from csv using rdfcon"^^xsd:string .'
              ></textarea>
            </div>
          </div>

          <div class="field">
            <div class="control">
              <button class="button is-primary" type="submit">
                Download YAML
              </button>
            </div>
          </div>
        </form>
      </div>
    </section>

    <script src="https://unpkg.com/n3/browser/n3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <script>
      // clear inFile selection
      document
        .getElementById("clearInfile")
        .addEventListener("click", function () {
          document.getElementById("infile").value = "";
        });

      // auto suggest column names from csv headers
      document.getElementById("infile").addEventListener("change", function () {
        const file = this.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
          const text = e.target.result;
          // Get the first line for headers
          const firstLine = text.split(/\r?\n/)[0];
          // Split headers (basic CSV parse; for more complex CSVs, use a library)
          const headers = firstLine.split(",");
          const datalist = document.getElementById("csvHeaders");
          datalist.innerHTML = "";
          headers.forEach((header) => {
            const opt = document.createElement("option");
            opt.value = header.trim();
            datalist.appendChild(opt);
          });
        };
        reader.readAsText(file);
      });

      let columnCount = 0;

      document
        .getElementById("addColumn")
        .addEventListener("click", function () {
          const container = document.getElementById("columnsContainer");
          const columnDiv = document.createElement("div");
          columnDiv.classList.add("column-spec");

          columnDiv.innerHTML = `
          <details open>
          <summary>Column: ${columnCount + 1}
          <button style="margin-left: 10px" type="button" class="removeColumn">Remove</button>
          </summary>
          <label>Column Name:</label>
          <input type="text" name="column[${columnCount}][column]" required placeholder="ColumnName" list="csvHeaders" />
          <p class="help"><span class="required">[required]</span> Name of the column.</p><p class="hint">press down-arrow for suggestions</p>

          <label>Predicate:</label>
          <input type="text" name="column[${columnCount}][predicate]" required placeholder="schema:headline" />
          <p class="help"><span class="required">[required]</span> Predicate to use in RDF.</p>

          <label>Datatype:</label>
          <input type="text" name="column[${columnCount}][datatype]" placeholder="xsd:string" list="datatypes" />
          <datalist id="datatypes">
            <option value="xsd:date">
            <option value="xsd:dateTime">
            <option value="xsd:token">
            <option value="xsd:anyURI">
            <option value="xsd:int">
            <option value="xsd:float">
            <option value="xsd:string">
          </datalist>
          <p class="help">Datatype of the column data. Default is <code>xsd:string</code>.</p>

          <details>
          <summary>Transformations<br /></summary>
          <label>Date Format String:</label>
          <input type="text" name="column[${columnCount}][datestr]" placeholder="%d/%m/%Y %H:%M:%S" />
          <p class="help">
            A <a href="https://docs.python.org/3/library/datetime.html#format-codes" target="_blank">python date format string</a>
            specifying the structure of the date(time) values in the column,
            if ommitted then date(time)s will be assumed to be in ISO format.
          </p>

          <label>Separator:</label>
          <input type="text" name="column[${columnCount}][separator]" placeholder="||" />
          <p class="help">A separator used to delineate multiple values per cell. Default is <code>null</code>.</p>
          <p class="hint">
            Turn Regex on to get more power. for example, to split on all commas preceded by a single
            letter, <code>(?<=[a-zA-Z],)</code> as in <code>'John D, Kate B' --> ['John D', 'Kate B']</code>
          </p>

          <label>Regex:</label>
          <input type="checkbox" name="column[${columnCount}][regex]" />
          <p class="help">If true, then treat the seperator as a regex pattern</p>
          </details>

          <details>
          <summary>IRI Creation<br /></summary>
          <label>As IRI:</label>
          <input type="checkbox" name="column[${columnCount}][as_iri]" />
          <p class="help">If the value should be treated as an IRI, set this to <code>true</code>. Default is <code>false</code>.</p>

          <label>Namespace:</label>
          <input type="text" name="column[${columnCount}][namespace]" placeholder="https://example.org/agent/" />
          <p class="help">A namespace to use for the IRI. Only used if <code>as_iri</code> is <code>true</code> and the values for this column are not already IRIs.</p>

          <label>As UUID:</label>
          <input type="checkbox" name="column[${columnCount}][as_uuid]" />
          <p class="help">If <code>true</code>, create a UUID for the IRI instead of just using the values from the column. Only used if <code>as_iri</code> is <code>true</code>. Default is <code>false</code>.</p>

          <label>Ignore Case:</label>
          <input type="checkbox" name="column[${columnCount}][ignore_case]" />
          <p class="help">If <code>true</code>, apply a lowercase transformation on the column values before minting the UUID. Only used if <code>as_iri</code> is <code>true</code>. Default is <code>false</code>.</p>

          <label>Label:</label>
          <input type="text" name="column[${columnCount}][label]" placeholder="schema:name" />
          <p class="help">If given, declare a label for the minted IRI using this predicate and the original value of the cell.</p>

          <label>Type:</label>
          <input type="text" name="column[${columnCount}][type]" placeholder="schema:Text" />
          <p class="help">If given, declare the minted IRI as an instance of this class.</p>
          </details>
          </details>
        `;
          columnCount++;

          container.appendChild(columnDiv);

          columnDiv
            .querySelector(".removeColumn")
            .addEventListener("click", function () {
              container.removeChild(columnDiv);
            });
        });

      document
        .getElementById("schemaForm")
        .addEventListener("submit", function (event) {
          event.preventDefault();
          const formData = new FormData(event.target);
          const data = {
            columns: [],
          };

          formData.forEach((value, key) => {
            if (key === "types") {
              const types = value.split(",").map((item) => item.trim());
              const filtered = types.filter((item) => item !== "");
              if (filtered.length > 0) {
                data[key] = filtered;
              }
            } else if (key === "infile") {
              data[key] = value.name;
            } else if (key === "identifier") {
              data[key] = value.replaceAll('"', "");
            } else if (key.startsWith("column")) {
              const columnIndexMatch = key.match(/column\[(\d+)\]/);
              if (columnIndexMatch) {
                const columnIndex = parseInt(columnIndexMatch[1], 10);
                const columnKey = key.split("]")[1].substring(1);
                if (!data.columns[columnIndex]) {
                  data.columns[columnIndex] = {};
                }
                if (value === "on") {
                  data.columns[columnIndex][columnKey] = true;
                } else if (value === "off") {
                  data.columns[columnIndex][columnKey] = false;
                } else {
                  if (columnKey === "column") {
                    data.columns[columnIndex][columnKey] =
                      value.replaceAll('"', "") || null;
                  } else {
                    data.columns[columnIndex][columnKey] = value || null;
                  }
                }
              }
            } else {
              data[key] = value || null;
            }
          });
          const turtlePrefixes = document.getElementById("prefixes").value;
          const parser = new N3.Parser();
          const prefixes = {};

          parser.parse(turtlePrefixes, (error, quad, prefixesMap) => {
            if (error) {
              console.error(error);
              window.alert(
                "Could not parse the given prefixes, please double check that it is valid RDF",
              );
              return;
            }
            if (prefixesMap) {
              Object.entries(prefixesMap).forEach(([prefix, uri]) => {
                prefixes[prefix] = `<${uri}>`;
              });
            }
            data.prefixes = Object.entries(prefixes).map(([prefix, uri]) => ({
              [prefix]: uri,
            }));

            // Remove null properties
            const cleanData = JSON.parse(
              JSON.stringify(data, (key, value) => {
                return value === null ? undefined : value;
              }),
            );

            const yamlData = jsyaml.dump(cleanData);
            const blob = new Blob([yamlData], { type: "text/yaml" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `${cleanData["infile"].substring(0, cleanData["infile"].length - 4)}-rdfcon.yaml`;
            a.click();
            URL.revokeObjectURL(url);
          });
        });
    </script>
  </body>
</html>
